# CI/CD workflow: Build, Test, Coverage, and Publish to npm
# Single consolidated workflow for all CI/CD needs

name: CI/CD

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  # Manual trigger for on-demand publishing
  workflow_dispatch:
    inputs:
      publish:
        description: 'Publish to npm after build'
        required: true
        default: true
        type: boolean

# Minimal permissions
permissions:
  contents: read

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # JOB 1: Validate, Lint, Test, Build
  # ============================================
  validate:
    name: Validate & Build
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      # Checkout with history for coverage comparison
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # Setup Node.js LTS with npm caching
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # LTS compatible with Expo SDK 53
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      # Deterministic install with locked dependencies
      - name: Install dependencies
        run: npm ci

      # TypeScript type checking
      - name: TypeScript check
        run: npx tsc --noEmit -p tsconfig-cli.json

      # Linting (if script exists)
      - name: Lint check
        run: npm run lint:check --if-present || echo "No lint script, skipping"

      # Unit tests with coverage
      - name: Run tests with coverage
        run: npx jest --coverage --passWithNoTests

      # Upload coverage to Codecov
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: neweracy/IgniteParseAuthKit
          fail_ci_if_error: false

      # Expo validation (if template exists)
      - name: Expo validation
        run: |
          if [ -f "template/package.json" ]; then
            cd template
            npm install --legacy-peer-deps || true
            npx expo-doctor@latest || echo "Expo doctor found issues (non-blocking)"
          else
            echo "No template directory, skipping Expo validation"
          fi

      # Build the CLI package - fails if build fails
      - name: Build CLI
        run: npm run build

      # Verify package can be packed
      - name: Verify package
        run: |
          npm pack --dry-run
          echo "✅ Package is ready for publishing"

      # Upload build artifacts for publish job
      - name: Upload build artifacts
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 1

  # ============================================
  # JOB 2: Publish to npm (main branch only)
  # ============================================
  publish:
    name: Publish to npm
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 10

    # Only publish on push/dispatch to main, not from forks
    if: |
      ((github.event_name == 'push' && github.ref == 'refs/heads/main') ||
       (github.event_name == 'workflow_dispatch' && inputs.publish)) &&
      github.repository == 'neweracy/IgniteParseAuthKit'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      # Download build artifacts
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Install dependencies
        run: npm ci

      # Prevent double-publish by checking npm registry
      - name: Check if version exists
        id: version-check
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          echo "name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          
          if npm view "$PACKAGE_NAME@$PACKAGE_VERSION" version 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "⚠️ Version $PACKAGE_VERSION already published"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "✅ Version $PACKAGE_VERSION ready to publish"
          fi

      # Publish only if version is new
      - name: Publish to npm
        if: steps.version-check.outputs.exists == 'false'
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish result
        run: |
          if [ "${{ steps.version-check.outputs.exists }}" == "true" ]; then
            echo "::warning::Skipped - v${{ steps.version-check.outputs.version }} already exists"
          else
            echo "::notice::Published ${{ steps.version-check.outputs.name }}@${{ steps.version-check.outputs.version }}"
          fi